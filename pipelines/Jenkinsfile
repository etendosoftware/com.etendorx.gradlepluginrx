pipeline {
  options {
    disableConcurrentBuilds()
  }

  environment {
    REPO_URL            = 'https://github.com/etendosoftware/com.etendorx.gradlepluginrx'
    REPO_NAME           = 'com.etendorx.gradlepluginrx'
    ACCESS_TOKEN        = credentials('access_token_github')
    EMAIL_ADDRESS       = "lucas.aguirre@smfconsulting.es"//credentials('email_builds')
    CONTEXT_BUILD       = "Plugin RX Tests"


    CONTEXT_NAME        = 'etendo'
    BBDD_SID            = 'etendo'
    BBDD_PORT           = '5432'
    BBDD_SYSTEMUSER     = 'postgres'
    BBDD_SYSTEMPASS     = 'syspass'
    BBDD_USER           = 'tad'
    BBDD_PASSWORD       = 'tad'
    NEXUS_USER          = credentials('nexus-admin-user')
    NEXUS_PASSWORD      = credentials('nexus-admin-passwd')
    GITHUB_USER         = 'etendobot'
    GITHUB_TOKEN        = credentials('github-read-package-token')
    LANG                = 'en_US.UTF-8'

    COMMIT_PENDING_STATUS = "pending"
    COMMIT_SUCCESS_STATUS = "success"
    COMMIT_FAILED_STATUS  = "failure"
  }

  agent {
    kubernetes {
      inheritFrom 'jenkins-node-gradle'
      defaultContainer 'jnlp'
      yaml """
apiVersion: v1
kind: Pod
metadata:
  name: jenkins-node-core-unittests-0
  namespace: jenkins
  labels:
    app.kubernetes.io/name: jenkins-node-core-unittests
spec:
  volumes:
    - name: rsa-keys
      configMap:
        name: rsa-keys
        defaultMode: 384
    - name: docker-sock
      hostPath:
        path: /var/run/docker.sock
        type: ''
  containers:
    - name: compiler
      image: etendo/compiler_jenkins:1.0.6
      ports:
        - name: ssh
          containerPort: 22
          protocol: TCP
        - name: visualvm
          containerPort: 8000
          protocol: TCP
      resources:
        limits:
          cpu: 3072m
          memory: 5000Mi
        requests:
          cpu: 3072m
          memory: 5000Mi
      volumeMounts:
        - name: rsa-keys
          mountPath: /root/.ssh/
        - name: docker-sock
          mountPath: /var/run/docker.sock
      lifecycle:
        postStart:
          exec:
            command:
              - bash
              - '-c'
              - >-
                chmod a+x /var/run/docker.sock && rm
                /etc/apt/sources.list.d/pgdg.list || echo 0 && apt update && apt
                install -y curl
      terminationMessagePath: /dev/termination-log
      terminationMessagePolicy: File
      imagePullPolicy: IfNotPresent
    - name: postgres
      image: postgres:14
      workingDir: /home/jenkins
      env:
        - name: POSTGRES_PASSWORD
          value: syspass
      resources: {}
      terminationMessagePath: /dev/termination-log
      terminationMessagePolicy: File
      imagePullPolicy: IfNotPresent
  restartPolicy: Always
  terminationGracePeriodSeconds: 30
  dnsPolicy: ClusterFirst
  serviceAccountName: default
  serviceAccount: default
  securityContext: {}
"""
    }
  }

  stages {
    stage('Setup') {
      steps {
        container('compiler') {
          script {
            sh "git config --global --add safe.directory /home/jenkins/agent/workspace/test_plugin_rx"
            sh "./pipelines/update.sh ${REPO_NAME} ${COMMIT_PENDING_STATUS} 'Tests in progress' ${ACCESS_TOKEN} ${GIT_COMMIT} ${BUILD_URL} '${CONTEXT_BUILD}'"
          }
        }
      }
    }

    stage('Run Tests') {
      steps {
        container('compiler') {
          script {
            try {
              sh """
                echo -e "context.name=${CONTEXT_NAME}\n
                bbdd.sid=${BBDD_SID}\n
                bbdd.port=${BBDD_PORT}\n
                bbdd.systemUser=${BBDD_SYSTEMUSER}\n
                bbdd.systemPassword=${BBDD_SYSTEMPASS}\n
                bbdd.user=${BBDD_USER}\n
                bbdd.password=${BBDD_PASSWORD}\n
                nexusUser=${NEXUS_USER}\n
                nexusPassword=${NEXUS_PASSWORD}\n
                githubUser=${GITHUB_USER}\n
                githubToken=${GITHUB_TOKEN}\n
                allow.root=true\n
                org.gradle.jvmargs=-Xmx3g -XX:MaxPermSize=1024m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8" > gradle.properties
              """
              sh './gradlew test'
              publishHTML([
                  allowMissing: true,
                  alwaysLinkToLastBuild: false,
                  keepAll: true,
                  reportDir: 'build/reports/tests/test',
                  reportFiles: '*.html',
                  reportName: 'STANDALONE TESTS REPORT',
                  reportTitles: ''
              ])
            } catch (Exception e) {
              currentBuild.result = 'FAILURE'
              error("Tests failed: ${e.message}")
              publishHTML([
                  allowMissing: false,
                  alwaysLinkToLastBuild: false,
                  keepAll: true,
                  reportDir: 'build/reports/tests/test',
                  reportFiles: '*.html',
                  reportName: 'STANDALONE TESTS REPORT',
                  reportTitles: ''
              ])
            }
          }
        }
      }
    }
  }

  post {
    success {
      script {
        sh "./pipelines/update.sh ${REPO_NAME} ${COMMIT_SUCCESS_STATUS} 'Tests passed' ${ACCESS_TOKEN} ${GIT_COMMIT} ${BUILD_URL} '${CONTEXT_BUILD}'"
      }
      mail to: EMAIL_ADDRESS,
      subject: "✅ TESTS PASSED - ${currentBuild.fullDisplayName}",
      body: """
Los tests para el Plugin RX han pasado exitosamente.

Commit: ${REPO_URL}/commit/${GIT_COMMIT}
Build URL: ${BUILD_URL}

Saludos,
Jenkins
"""
    }
    failure {
      script {
        sh "./pipelines/update.sh ${REPO_NAME} ${COMMIT_FAILED_STATUS} 'Tests failed' ${ACCESS_TOKEN} ${GIT_COMMIT} ${BUILD_URL} '${CONTEXT_BUILD}'"
      }
      mail to: EMAIL_ADDRESS,
      subject: "❌ TESTS FAILED - ${currentBuild.fullDisplayName}",
      body: """
Los tests para el Plugin RX han fallado.

Commit: ${REPO_URL}/commit/${GIT_COMMIT}
Build URL: ${BUILD_URL}

Por favor, revisa los logs para más detalles.

Saludos,
Jenkins
"""
    }
  }
}
